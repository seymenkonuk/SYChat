import{key as storage_key,app_name}from"./src/config.min.js";import{initStorage,getStorage,putStorage}from"./src/storage.min.js";import{generateRandomKey,generateRandomHex,encryptText,decryptText}from"./src/aes.min.js";import{handleDropFile,downloadFile}from"./src/file.min.js";import{hexToArrayBuffer,arrayBufferToHex,generateKey,exportPublicKey,exportPrivateKey,diffieHellman}from"./src/key-change.min.js";const getFootprintInput=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[3]/header/header/div/div[1]/h1",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,addFootprint=()=>{const e=getFootprintInput();document.title=app_name,e&&(e.title=app_name,e.innerHTML=app_name)},getSideBar=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/header/div/div[1]/div",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,getMessages=()=>{const e=document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/div[2]/div/div[2]/div[last()-1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e?e.querySelectorAll(`[role="row"]:not([${app_name}-isRead="true"])`):[]},getMessage=(e,t)=>{const n=document.evaluate("./div/div/div[1]/div[1]/div[1]/div/div/div[1]/div/span[1]",e[t],null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e[t].setAttribute(`${app_name}-isRead`,"true"),n},getQuotedMessage=(e,t)=>{const n=document.evaluate("./div/div/div[1]/div[1]/div[1]/div/div/div[1]/div[1]/div/div/div/div/div[2]/span",e[t],null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e[t].setAttribute(`${app_name}-isRead`,"true"),n},getReplyMessage=(e,t)=>{const n=document.evaluate("./div/div/div[1]/div[1]/div[1]/div/div/div[1]/div[2]/span[1]",e[t],null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e[t].setAttribute(`${app_name}-isRead`,"true"),n},getPersonName=()=>{const e=document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/header/div[2]/div[1]/div[1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e?e.innerText.replace(/[\n\r]+/g," "):null};async function getKey(e){const t=await getStorage();return!!(t&&t.keys&&t.keys[e]&&t.keys[e].value)&&t.keys[e].value}const getAddFileButton=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div/div[1]/button",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,getFileInput=async()=>{const e=document.evaluate("/html/body/div[1]/div/div/span[6]/div/ul/div/div/div[1]/li/div/input",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return new Promise(e?t=>{t(e)}:e=>{getAddFileButton().click(),setTimeout((async()=>{const t=await getFileInput();e(t)}),100)})},getMessageInput=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div/div[3]/div",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,getTypingMessage=()=>{const e=getMessageInput();if(!e)return"";let t=e.innerText;return t=t.trim(),t=t.replace(/(\n{2,})/g,(function(e){return"\n".repeat(Math.ceil(e.length/2))})),t},pressSendMessage=()=>{const e=document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div/div[4]/button",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;e&&e.click()},sendMessage=e=>{const t=getMessageInput();if(!t)return new Promise((e=>{e(!1)}));t.focus();const n=document.createRange();n.selectNodeContents(t);const i=window.getSelection();return i.removeAllRanges(),i.addRange(n),new Promise((n=>{setTimeout((()=>{document.execCommand("insertText",!1,e),t.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{pressSendMessage(),n(!0)}),100)}),100)}))},sendPublicKey=async e=>{const t=await generateKey(),n=await exportPublicKey(t.publicKey),i=await exportPrivateKey(t.privateKey);sendMessage(`${app_name}_START_PUBLIC_KEY`+n+`${app_name}_END_PUBLIC_KEY`);let a=await getStorage();a.keys||(a.keys={}),a.keys[e]||(a.keys[e]={}),a.keys[e].my_public_hex=n,a.keys[e].my_private_hex=i,await putStorage(a),await checkDiffie(e)},isPublicKey=e=>{const t=`${app_name}_START_PUBLIC_KEY`,n=`${app_name}_END_PUBLIC_KEY`,i=e.startsWith(t),a=e.endsWith(n);return!(!i||!a)},checkReceivePublicKey=async e=>{const t=e?e.innerText:"",n=getPersonName();if(!n||!isPublicKey(t))return new Promise((e=>{e(!1)}));const i=`${app_name}_START_PUBLIC_KEY`,a=`${app_name}_END_PUBLIC_KEY`,s=t.slice(i.length,t.length-a.length);let d=await getStorage();if(d.keys||(d.keys={}),d.keys[n]||(d.keys[n]={}),d.keys[n].my_public_hex===s)return new Promise((e=>{e(!1)}));d.keys[n].public_hex=s,await putStorage(d);const r=await checkDiffie(n);return new Promise((e=>{e(r)}))},checkDiffie=async e=>{let t=await getStorage();if(t.keys||(t.keys={}),t.keys[e]||(t.keys[e]={}),!t.keys[e].public_hex||!t.keys[e].my_private_hex)return new Promise((e=>{e(!1)}));const n=t.keys[e].public_hex,i=t.keys[e].my_private_hex,a=await diffieHellman(i,n);return t.keys[e]={value:a},await putStorage(t),new Promise((e=>{e(!0)}))},notificateKeyError=e=>{chrome.runtime.sendMessage({type:"createNotification",name:e},(async()=>{confirm("Anahtar bulunamadı! Public anahtarınızı paylaşmak ister misiniz?")&&sendPublicKey(e)}))},sendEncryptedMessage=async()=>{const e=getTypingMessage(),t=getPersonName();if(!e||!t)return;const n=await getKey(t);if(!n)return notificateKeyError(t);try{const t=JSON.stringify({message:e,random:generateRandomKey(32),file:[]}),i=encryptText(t,n);sendMessage(i)}catch{}},showFullMessage=e=>{const t=e.querySelector(".read-more-button");return t&&t.click(),new Promise((e=>{setTimeout((()=>{e(!!t)}),100)}))},decryptMessage=async(e,t,n)=>{if(e&&t&&n){for(;await showFullMessage(e););try{const e=decryptText(t.innerText,n);if(!e)return;const i=JSON.parse(e);if(!i||!i.message)return;t.innerHTML=i.message}catch{return}}},receiveNewMessage=async()=>{const e=getMessages();if(!e)return;const t=getPersonName();if(!t)return;let n=await getKey(t);const i=e.length;for(let a=i-1;a>=0;a--)if(!n&&await checkReceivePublicKey(getMessage(e,a))){n=await getKey(t);break}for(let t=0;t<i;t++)decryptMessage(e[t],getMessage(e,t),n),decryptMessage(e[t],getQuotedMessage(e,t),n),decryptMessage(e[t],getReplyMessage(e,t),n)},handleNewMessage=()=>{setInterval((()=>{const e=getMessages();e&&e.length>0&&receiveNewMessage()}),500)},handleCtrlEnter=()=>{document.body.addEventListener("keydown",(function(e){!e.ctrlKey||e.shiftKey||e.altKey||"Enter"!=e.key||(e.preventDefault(),sendEncryptedMessage())}))},decryptFile=(e,t,n,i,a)=>{try{t=decryptText(t,e);const n=JSON.parse(t);return""==n.type&&(n.type="application/octet-stream"),n&&n.data&&n.type&&n.size&&n.random&&5==Object.keys(n).length?(n.data=hexToArrayBuffer(n.data),downloadFile(n),!0):!1}catch{return!1}},handleFile=async({data:e,name:t,type:n,size:i})=>{""==n&&(n="application/octet-stream");const a=getPersonName();if(!(a&&e&&n&&t&&i))return!1;const s=await getKey(a);if(!s)return notificateKeyError(a);const d=new TextDecoder("utf-8").decode(e);if(!decryptFile(s,d))try{const a=arrayBufferToHex(e);e=JSON.stringify({data:a,name:t,size:i,type:n,random:generateRandomKey(32)}),e=encryptText(e,s);const d=new File([e],generateRandomHex(32)+".txt",{type:"text/plain"}),r=new DataTransfer;r.items.add(d);const o=await getFileInput();o.files=r.files;const l=new Event("change",{bubbles:!0});o.dispatchEvent(l)}catch{}},createFileInput=()=>{const e=getSideBar(),t=document.createElement("div");t.style.cssText="width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; border-radius: 50%",t.classList.add("bg-img"),t.classList.add("upload"),t.style.backgroundImage=`url(${chrome.runtime.getURL("img/upload.png")})`,t.addEventListener("dragover",(function(e){e.preventDefault(),t.style.backgroundColor="grey"})),t.addEventListener("dragleave",(function(){t.style.backgroundColor="#0B3160"})),t.addEventListener("drop",(async function(e){e.preventDefault(),t.style.backgroundColor="#0B3160",handleDropFile(e,handleFile)})),e.appendChild(t)};export const waitForReady=()=>{if(!getFootprintInput())return setTimeout(waitForReady,500);initStorage(storage_key),addFootprint(),createFileInput(),handleCtrlEnter(),handleNewMessage()};