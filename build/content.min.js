import{key as storage_key,app_name}from"./src/config.min.js";import{initStorage,getStorage,putStorage}from"./src/storage.min.js";import{generateRandomKey,generateRandomHex,encryptText,decryptText}from"./src/aes.min.js";import{handleDropFile,downloadFile}from"./src/file.min.js";import{hexToArrayBuffer,arrayBufferToHex,generateKey,exportPublicKey,exportPrivateKey,diffieHellman}from"./src/key-change.min.js";const getFootprintInput=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[3]/header/header/div/div[1]/h1",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,addFootprint=()=>{const e=getFootprintInput();document.title=app_name,e&&(e.title=app_name,e.innerHTML=app_name)},getSideBar=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/header/div/div/div/div/span/div/div[1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,getMessagesWrapper=e=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/div[3]/div/div[2]/div[last()-1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,getMessage=e=>{const t=`/html/body/div[1]/div/div/div[3]/div/div[4]/div/div[3]/div/div[2]/div[last()-1]/div[${e}]/div/div/div[1]/div[1]/div[1]/div/div[1]/div/span[1]`;return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},getQuotedMessage=e=>{const t=`/html/body/div[1]/div/div/div[3]/div/div[4]/div/div[3]/div/div[2]/div[last()-1]/div[${e}]/div/div/div[1]/div[1]/div[1]/div/div[1]/div[1]/div/div/div/div/div[2]/span`;return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},getReplyMessage=e=>{const t=`/html/body/div[1]/div/div/div[3]/div/div[4]/div/div[3]/div/div[2]/div[last()-1]/div[${e}]/div/div/div[1]/div[1]/div[1]/div/div[1]/div[2]/span[1]`;return document.evaluate(t,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},getPersonName=()=>{let e=document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/header/div[2]/div[1]/div[1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return e?e.innerText.replace(/[\n\r]+/g," "):null};async function getKey(e){const t=await getStorage();return!!(t&&t.keys&&t.keys[e]&&t.keys[e].value)&&t.keys[e].value}const getAddFileButton=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[1]/div/button",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,getFileInput=async()=>{const e=document.evaluate("/html/body/div[1]/div/div/span[5]/div/ul/div/div/div[1]/li/div/input",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return new Promise(e?t=>{t(e)}:e=>{getAddFileButton().click(),setTimeout((async()=>{const t=await getFileInput();e(t)}),100)})},getMessageInput=()=>document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div[1]/div[2]/div[1]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,getTypingMessage=()=>{const e=getMessageInput();if(!e)return"";let t=e.innerText;return t=t.trim(),t=t.replace(/(\n{2,})/g,(function(e){return"\n".repeat(Math.ceil(e.length/2))})),t},pressSendMessage=()=>{const e=document.evaluate("/html/body/div[1]/div/div/div[3]/div/div[4]/div/footer/div[1]/div/span/div/div[2]/div[2]/button",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;e&&e.click()},sendMessage=e=>{const t=getMessageInput();if(!t)return new Promise((e=>{e(!1)}));t.focus();const i=document.createRange();i.selectNodeContents(t);const n=window.getSelection();return n.removeAllRanges(),n.addRange(i),new Promise((i=>{setTimeout((()=>{document.execCommand("insertText",!1,e),t.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((()=>{pressSendMessage(),i(!0)}),100)}),100)}))},sendPublicKey=async e=>{const t=await generateKey(),i=await exportPublicKey(t.publicKey),n=await exportPrivateKey(t.privateKey);sendMessage(`${app_name}_START_PUBLIC_KEY`+i+`${app_name}_END_PUBLIC_KEY`);let a=await getStorage();a.keys||(a.keys={}),a.keys[e]||(a.keys[e]={}),a.keys[e].my_public_hex=i,a.keys[e].my_private_hex=n,await putStorage(a),await checkDiffie(e)},isPublicKey=e=>{const t=`${app_name}_START_PUBLIC_KEY`,i=`${app_name}_END_PUBLIC_KEY`,n=e.startsWith(t),a=e.endsWith(i);return!(!n||!a)},checkReceivePublicKey=async e=>{const t=e?e.innerText:"",i=getPersonName();if(!i||!isPublicKey(t))return new Promise((e=>{e(!1)}));const n=`${app_name}_START_PUBLIC_KEY`,a=`${app_name}_END_PUBLIC_KEY`,d=t.slice(n.length,t.length-a.length);let s=await getStorage();if(s.keys||(s.keys={}),s.keys[i]||(s.keys[i]={}),s.keys[i].my_public_hex===d)return new Promise((e=>{e(!1)}));s.keys[i].public_hex=d,await putStorage(s);const r=await checkDiffie(i);return new Promise((e=>{e(r)}))},checkDiffie=async e=>{let t=await getStorage();if(t.keys||(t.keys={}),t.keys[e]||(t.keys[e]={}),!t.keys[e].public_hex||!t.keys[e].my_private_hex)return new Promise((e=>{e(!1)}));const i=t.keys[e].public_hex,n=t.keys[e].my_private_hex,a=await diffieHellman(n,i);return t.keys[e]={value:a},await putStorage(t),new Promise((e=>{e(!0)}))},notificateKeyError=e=>{chrome.runtime.sendMessage({type:"createNotification",name:e},(async()=>{confirm("Anahtar bulunamadı! Public anahtarınızı paylaşmak ister misiniz?")&&sendPublicKey(e)}))},sendEncryptedMessage=async()=>{const e=getTypingMessage(),t=getPersonName();if(!e||!t)return;const i=await getKey(t);if(!i)return notificateKeyError(t);try{const t=JSON.stringify({message:e,random:generateRandomKey(32),file:[]}),n=encryptText(t,i);sendMessage(n)}catch{}},showFullMessage=e=>{if(e.parentElement&&e.parentElement.children[1]&&e.parentElement.children[1].classList.contains("read-more-button"))return e.parentElement.children[1].click(),new Promise((e=>{setTimeout((()=>{e(!0)}),100)}))},decryptMessage=async(e,t)=>{if(!e||!t)return;if(!e.getAttribute(`${app_name}-isRead`)){await showFullMessage(e),e.setAttribute(`${app_name}-isRead`,"true");try{const i=decryptText(e.innerText,t);if(!i)return;const n=JSON.parse(i);if(!n||!n.message)return;e.innerHTML=n.message}catch{return}}},receiveNewMessage=async()=>{const e=getMessagesWrapper();if(!e)return;const t=getPersonName();if(!t)return;const i=await getKey(t);for(let t=e.children.length-1;t>=0&&(i||!checkReceivePublicKey(getMessage(t+1)));t--)decryptMessage(getMessage(t+1),i),decryptMessage(getQuotedMessage(t+1),i),decryptMessage(getReplyMessage(t+1),i)};let old_messages="";const handleNewMessage=()=>{setInterval((()=>{const e=getMessagesWrapper();e&&e.innerHTML!=old_messages&&(old_messages=e.innerHTML,receiveNewMessage())}),500)},handleCtrlEnter=()=>{document.body.addEventListener("keydown",(function(e){!e.ctrlKey||e.shiftKey||e.altKey||"Enter"!=e.key||(e.preventDefault(),sendEncryptedMessage())}))},decryptFile=(e,t,i,n,a)=>{try{t=decryptText(t,e);const i=JSON.parse(t);return""==i.type&&(i.type="application/octet-stream"),i&&i.data&&i.type&&i.size&&i.random&&5==Object.keys(i).length?(i.data=hexToArrayBuffer(i.data),downloadFile(i),!0):!1}catch{return!1}},handleFile=async({data:e,name:t,type:i,size:n})=>{""==i&&(i="application/octet-stream");const a=getPersonName();if(!(a&&e&&i&&t&&n))return!1;const d=await getKey(a);if(!d)return notificateKeyError(a);const s=new TextDecoder("utf-8").decode(e);if(!decryptFile(d,s))try{const a=arrayBufferToHex(e);e=JSON.stringify({data:a,name:t,size:n,type:i,random:generateRandomKey(32)}),e=encryptText(e,d);const s=new File([e],generateRandomHex(32)+".txt",{type:"text/plain"}),r=new DataTransfer;r.items.add(s);const l=await getFileInput();l.files=r.files;const o=new Event("change",{bubbles:!0});l.dispatchEvent(o)}catch{}},createFileInput=()=>{const e=getSideBar(),t=document.createElement("div");t.style.cssText="height: 40px; display: flex; justify-content: center; align-items: center; border-radius: 50%",t.classList.add("bg-img"),t.classList.add("upload"),t.style.backgroundImage=`url(${chrome.runtime.getURL("img/upload.png")})`,t.addEventListener("dragover",(function(e){e.preventDefault(),t.style.backgroundColor="grey"})),t.addEventListener("dragleave",(function(){t.style.backgroundColor="#0B3160"})),t.addEventListener("drop",(async function(e){e.preventDefault(),t.style.backgroundColor="#0B3160",handleDropFile(e,handleFile)})),e.appendChild(t)};export const waitForReady=()=>{if(!getFootprintInput())return setTimeout(waitForReady,500);initStorage(storage_key),addFootprint(),createFileInput(),handleCtrlEnter(),handleNewMessage()};